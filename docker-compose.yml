services:
  # ===================================================
  # ==               BACKEND SERVICE                 ==
  # ===================================================
  backend:
    build:
      context: ./node_backend
      # If your Dockerfile doesn't have a `development` stage,
      # remove the next line or rename it to the correct stage.
      target: development
    container_name: backend
    ports:
      - "3001:3001"
    volumes:
      - ./node_backend:/app
      - node_modules_backend:/app/node_modules
    env_file:
      - .env
    environment:
      # remove secrets already in .env; keep only overrides if any
      NODE_ENV: development
      PORT: "3001"
    command: npm run dev
    healthcheck:
      # Use wget (available in Alpine/busybox) instead of curl
      test: ["CMD-SHELL", "wget -qO- http://localhost:3001/health >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # ===================================================
  # ==               FRONTEND SERVICE                ==
  # ===================================================
  frontend:
    build:
      context: ./client
      # If your Dockerfile doesn't have a `development` stage,
      # remove the next line or rename it to the correct stage.
      target: development
    container_name: frontend
    ports:
      - "5173:5173"
    volumes:
      - ./client:/app
      - node_modules_client:/app/node_modules
    env_file:
      - .env.client
    environment:
      NODE_ENV: development
      # remove VITE_* here (now in .env.client); CHOKIDAR_* also moved
    command: npm run dev -- --host --port 5173
    healthcheck:
      # Vite dev server root
      test: ["CMD-SHELL", "wget -qO- http://localhost:5173 >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    depends_on:
      - backend

  # ===================================================
  # ==             DEVCONTAINER (UTILITY)            ==
  # ===================================================
  devcontainer:
    image: alpine:3.20
    container_name: devcontainer
    command: sleep infinity
    volumes:
      - .:/workspace:cached
      - devcontainer_bash_history:/root/.bash_history
    restart: unless-stopped

volumes:
  node_modules_backend:
  node_modules_client:
  devcontainer_bash_history:
  app-data:
    driver: local
