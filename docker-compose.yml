version: '3.8'

services:
  # ===================================================
  # ==               BACKEND SERVICE                 ==
  # ===================================================
  backend:
    build:
      context: ./node_backend
      target: development
    container_name: backend
    ports:
      - "3000:3000"
    volumes:
      - ./node_backend:/app
      - node_modules_backend:/app/node_modules
    env_file:
      - .env
    command: npm run dev
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===================================================
  # ==               FRONTEND SERVICE                ==
  # ===================================================
  frontend:
    build:
      context: ./client
      target: development
    container_name: frontend
    ports:
      - "5173:5173"
    volumes:
      - ./client:/app
      - node_modules_client:/app/node_modules
    env_file:
      - .env
    # The --host flag is crucial for Vite's HMR to work in Docker
    command: npm run dev -- --host --port 5173
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:5173"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s # Give Vite time to start up
    restart: unless-stopped
    depends_on:
      - backend

  # ===================================================
  # ==             DEV CONTAINER SERVICE             ==
  # ===================================================
  # This is a lightweight container for VS Code to attach to.
  # It mounts the entire workspace and has basic tools installed.
  devcontainer:
    image: mcr.microsoft.com/devcontainers/base:ubuntu
    container_name: devcontainer
    # Keep the container running
    command: sleep infinity
    volumes:
      # Mount the entire project directory
      - .:/workspace:cached
      # Persist bash history
      - devcontainer_bash_history:/root/.bash_history
    # Make sure the dev container stays up so backend/frontend can run
    restart: unless-stopped

volumes:
  node_modules_backend:
  node_modules_client:
  devcontainer_bash_history:
